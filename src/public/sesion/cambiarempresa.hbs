<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{titulo}} - Seleccionar empresa</title>
    <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/assets/nprogress/nprogress.css" rel="stylesheet" />
    <link href="/assets/animate.css/animate.min.css" rel="stylesheet" />
    <link href="/assets/toastr/toastr.css" rel="stylesheet" />
    <link href="/assets/build/css/custom.css" rel="stylesheet" />
  </head>
  <body class="login">
    <div>
      <a class="hiddenanchor" id="signup"></a>
      <a class="hiddenanchor" id="signin"></a>
      <div class="login_wrapper">
        <div class="animate form login_form">
          <section class="login_content">
            <form id="frmlogin">
              <h1>Seleccione empresa</h1>
              <div>
                <select id="idEmpresa" name="idEmpresa" class="form-control">
                    <option value="">Cargando...</option>
                </select>
              </div>
              <div class="clearfix"></div>
            </form>
          </section>
        </div>
      </div>
    </div>

    <script src="/assets/jquery/dist/jquery.min.js"></script>
    <script src="/assets/toastr/toastr.js"></script>
    <script>
      $(document).on("ready", function() {
        $("#aceptar").on("click", aceptar_click);
        $("#usuario").on("keyup", txt_keyup);
        $("#clave").on("keyup", txt_keyup);
        //$("#aceptar").attr("disabled", "disabled");
        //leerEmpresas();
        $("#usuario").trigger("focus");        
        $("#usuario").val("admin");
        $("#clave").val("12345");
      });

      function aceptar_click() {
        if ($("#usuario").val().trim().length == 0 || $("#clave").val().trim().length == 0) {
          toastr.error("El usuario o clave son incorrectos. Intente nuevamente", "", {timeOut: 700});
          return;
        }

        var credenciales = $("#frmlogin").serializeArray();
        var iniciarServicio = $.ajax({ type: "POST", url: "/api/usuario/login", data: credenciales });
        iniciarServicio.done(function(data, textStatus, jqXHR){
          if (data.ok) {
            var activacion = data.data[0];
            alert(JSON.stringify(activacion));
            var iniciarWeb = $.ajax({ type: "POST", url: "/sesion/iniciar", data: activacion });
            iniciarWeb.done(function(data1, textStatus, jqXHR) {
              if (data1.ok) {
                toastr.success(data1.message, "", {timeOut: 700});
                setTimeout(function(){ window.location.href = "/inicio" }, 700);
              }
            });
            iniciarWeb.fail(function(jqXHR, textStatus, errorThrown) {
              toastr.error(textStatus);
            });
            return;
          }
          toastr.error(data.message);
        });
        iniciarServicio.fail(function(jqXHR, textStatus, errorThrown) {
          toastr.error(textStatus);
        });
      }

      function txt_keyup(event){
        if (event.keyCode === 13) {
          event.preventDefault();
          $("#aceptar").trigger("click");
        }
      }

      function leerEmpresas(){
        var svc0 = $.ajax({type: "GET", url: "/api/empresa/list"});
        svc0.done(function (data, textStatus, jqXHR) {
          $("#idEmpresa option").remove();
          $.each(data.data, function(i, item) {
              $("#idEmpresa").append(new Option(item.EmpresaAbrev, item.IdEmpresa));
          });
          $("#aceptar").removeAttr("disabled");
        });
        svc0.fail(function (jqXHR, textStatus, errorThrown) {
          toastr.error("Error al obtener el listado de empresas.");
        });
      }
    </script>
  </body>
</html>